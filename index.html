<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:     #0d0d14;
  --bg1:    #13131c;
  --bg2:    #1a1a26;
  --bg3:    #22223a;
  --text:   #f0f0f8;
  --text2:  #8888aa;
  --text3:  #44445a;
  --accent: #7c6dff;
  --a2:     #a78bfa;
  --green:  #22d47e;
  --red:    #ff4d6d;
  --orange: #ffb347;
  --r:      20px;
  --r2:     14px;
  --nav:    64px;
  --safe:   env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
html,body{height:100%;overflow:hidden;font-family:'Manrope',-apple-system,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
button,input,textarea{font-family:inherit;}
::-webkit-scrollbar{display:none;}

/* â•â•â• LAYOUT â•â•â• */
#app{display:flex;flex-direction:column;height:100dvh;}
.screen{
  position:absolute;inset:0 0 calc(var(--nav) + var(--safe) + 16px) 0;
  display:flex;flex-direction:column;
  opacity:0;pointer-events:none;transform:translateY(10px);
  transition:opacity .22s ease,transform .22s ease;
}
.screen.active{opacity:1;pointer-events:all;transform:translateY(0);}
.scr{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;}

/* â•â•â• FLOATING NAV â•â•â• */
.fnav{
  position:fixed;bottom:max(16px,var(--safe));left:50%;
  transform:translateX(-50%);
  display:flex;align-items:center;gap:2px;
  background:rgba(19,19,28,.92);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,.09);
  border-radius:100px;padding:6px;
  z-index:90;
  box-shadow:0 8px 40px rgba(0,0,0,.6),0 0 0 .5px rgba(255,255,255,.03);
}
.ni{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  width:72px;height:52px;border-radius:100px;border:none;
  background:transparent;cursor:pointer;color:var(--text3);
  transition:color .18s,background .18s;
  -webkit-tap-highlight-color:transparent;
}
.ni.on{background:rgba(124,109,255,.2);color:var(--accent);}
.ni svg{width:22px;height:22px;stroke-width:1.8;transition:transform .18s;}
.ni.on svg{transform:scale(1.08);}
.ni span{font-size:10px;font-weight:700;letter-spacing:.2px;}

/* â•â•â• PAGE HEADER â•â•â• */
.ph{padding:52px 20px 12px;flex-shrink:0;}
.ph h1{font-size:28px;font-weight:900;letter-spacing:-.6px;}
.ph p{font-size:13px;color:var(--text2);margin-top:3px;font-weight:500;}

/* â•â•â• CARD â•â•â• */
.card{background:var(--bg1);border-radius:var(--r);border:1px solid rgba(255,255,255,.05);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-chat{padding-bottom:0;}
#s-chat .screen-body{
  flex:1;display:flex;flex-direction:column;overflow:hidden;
  padding-top:env(safe-area-inset-top,0px);
}

/* EMPTY WELCOME STATE */
.chat-welcome{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 28px;text-align:center;gap:6px;
}
.cw-icon{font-size:52px;margin-bottom:8px;opacity:.85;}
.cw-title{font-size:20px;font-weight:900;letter-spacing:-.3px;margin-bottom:4px;}
.cw-sub{font-size:14px;color:var(--text2);font-weight:500;line-height:1.55;max-width:280px;}
.cw-chips{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:16px;}
.cw-chip{
  background:var(--bg2);border:1px solid rgba(255,255,255,.07);
  border-radius:100px;padding:8px 14px;font-size:13px;font-weight:600;
  color:var(--text2);cursor:pointer;transition:background .15s,color .15s;
  -webkit-tap-highlight-color:transparent;
}
.cw-chip:active{background:var(--bg3);color:var(--text);}

.msgs{
  flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  padding:12px 14px 8px;display:flex;flex-direction:column;gap:9px;
}
.msg{display:flex;flex-direction:column;max-width:82%;animation:mpop .2s cubic-bezier(.34,1.4,.64,1);}
.msg.u{align-self:flex-end;align-items:flex-end;}
.msg.b{align-self:flex-start;align-items:flex-start;}
.bbl{padding:11px 15px;border-radius:20px;font-size:15px;line-height:1.5;font-weight:500;}
.msg.u .bbl{background:linear-gradient(135deg,var(--accent),var(--a2));color:#fff;border-bottom-right-radius:5px;}
.msg.b .bbl{background:var(--bg2);color:var(--text);border-bottom-left-radius:5px;border:1px solid rgba(255,255,255,.06);}
.mtime{font-size:11px;color:var(--text3);margin-top:3px;padding:0 4px;font-weight:600;}

.tx-card{margin-top:9px;background:rgba(255,255,255,.08);border-radius:14px;padding:11px 13px;display:flex;align-items:center;gap:11px;}
.tx-ico{font-size:26px;flex-shrink:0;}
.tx-b{flex:1;}
.tx-d{font-size:14px;font-weight:700;}
.tx-c{font-size:12px;color:rgba(255,255,255,.5);margin-top:1px;}
.tx-s{font-size:17px;font-weight:800;}
.tx-s.expense{color:var(--red);}
.tx-s.income{color:var(--green);}

.typing-row{display:flex;align-items:center;gap:5px;padding:13px 15px;background:var(--bg2);border-radius:20px;border-bottom-left-radius:5px;border:1px solid rgba(255,255,255,.06);width:fit-content;}
.dot{width:7px;height:7px;background:var(--text3);border-radius:50%;animation:db .9s infinite;}
.dot:nth-child(2){animation-delay:.15s;}.dot:nth-child(3){animation-delay:.3s;}

.chat-bar{
  background:var(--bg1);
  border-top:1px solid rgba(255,255,255,.05);
  padding:10px 14px;
  padding-bottom:max(10px, calc(var(--safe) + var(--nav) + 26px));
  display:flex;align-items:flex-end;gap:10px;flex-shrink:0;
}
.inp-wrap{flex:1;background:var(--bg2);border-radius:22px;padding:10px 16px;border:1px solid rgba(255,255,255,.07);display:flex;align-items:center;}
#userInput{width:100%;background:none;border:none;outline:none;resize:none;font-size:15px;color:var(--text);max-height:120px;line-height:1.45;font-weight:500;}
#userInput::placeholder{color:var(--text3);}
.sbtn{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--a2));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 16px rgba(124,109,255,.4);transition:transform .12s,opacity .2s;}
.sbtn:active{transform:scale(.86);}
.sbtn:disabled{opacity:.35;box-shadow:none;}
.sbtn svg{width:18px;height:18px;fill:white;margin-left:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-stats .scr{padding:0 16px 16px;}
.sum-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;}
.sc{background:var(--bg1);border-radius:var(--r);padding:14px 10px;text-align:center;border:1px solid rgba(255,255,255,.05);}
.sc .lb{font-size:11px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;}
.sc .vl{font-size:16px;font-weight:800;letter-spacing:-.3px;}
.vl.inc{color:var(--green);}.vl.exp{color:var(--red);}
.sec{font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin:18px 0 9px;}
.ch-box{background:var(--bg1);border-radius:var(--r);padding:16px;border:1px solid rgba(255,255,255,.05);}
.ch-wrap{height:178px;position:relative;}
.cat-list{margin-top:14px;display:flex;flex-direction:column;gap:10px;}
.cr{display:flex;align-items:center;gap:10px;}
.cdot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.cn{flex:1;font-size:14px;font-weight:600;}
.ct{flex:0 0 66px;height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.cf{height:100%;border-radius:3px;transition:width .9s cubic-bezier(.34,1,.64,1);}
.ca{width:74px;text-align:right;font-size:13px;font-weight:700;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY + FILTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-history .scr{padding:0 16px 16px;}

.filter-row{
  display:flex;gap:6px;overflow-x:auto;padding:12px 0 4px;
  -webkit-overflow-scrolling:touch;flex-shrink:0;
  scrollbar-width:none;
}
.filter-row::-webkit-scrollbar{display:none;}
.ftag{
  flex-shrink:0;padding:8px 14px;border-radius:100px;
  border:1.5px solid rgba(255,255,255,.08);background:transparent;
  font-size:13px;font-weight:700;color:var(--text2);cursor:pointer;
  transition:all .15s;white-space:nowrap;
  -webkit-tap-highlight-color:transparent;
}
.ftag.on{background:var(--accent);border-color:var(--accent);color:#fff;}

.day-g{margin-bottom:12px;}
.day-lb{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;padding:8px 2px 6px;}
.day-items{background:var(--bg1);border-radius:var(--r);overflow:hidden;border:1px solid rgba(255,255,255,.05);}
.hi{display:flex;align-items:center;gap:12px;padding:13px 15px;border-bottom:1px solid rgba(255,255,255,.04);}
.hi:last-child{border-bottom:none;}
.hi-ico{width:42px;height:42px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.hi-ico.expense{background:rgba(255,77,109,.1);}
.hi-ico.income{background:rgba(34,212,126,.1);}
.hi-info{flex:1;}
.hi-d{font-size:15px;font-weight:600;}
.hi-c{font-size:12px;color:var(--text2);margin-top:2px;}
.hi-a{font-size:16px;font-weight:800;margin-left:auto;}
.hi-a.expense{color:var(--red);}
.hi-a.income{color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KOPILKA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-kopilka .scr{padding:0 16px 16px;}

.goal-card{
  background:var(--bg1);border-radius:var(--r);
  border:1px solid rgba(255,255,255,.06);
  overflow:hidden;margin-bottom:14px;
  animation:cin .28s cubic-bezier(.34,1.2,.64,1);
}
.g-inner{padding:18px 18px 14px;}
.g-head{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.g-emo{width:50px;height:50px;border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;}
.g-name{font-size:17px;font-weight:800;letter-spacing:-.2px;}
.g-sub{font-size:13px;color:var(--text2);margin-top:2px;font-weight:500;}
/* Delete button â€” larger touch target */
.g-del{
  margin-left:auto;background:rgba(255,77,109,.12);border:none;cursor:pointer;
  color:var(--red);width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  -webkit-tap-highlight-color:transparent;transition:background .15s;
}
.g-del:active{background:rgba(255,77,109,.28);}
.g-del svg{width:16px;height:16px;stroke-width:2.5;}

/* LIQUID BAR â€” SVG waves, no translate */
.liq-wrap{position:relative;height:72px;border-radius:16px;background:var(--bg3);overflow:hidden;margin-bottom:14px;}
.liq-fill{position:absolute;bottom:0;left:0;right:0;height:0%;transition:height 1.3s cubic-bezier(.34,1.2,.64,1);}
.wave-top{position:absolute;top:-18px;left:0;width:100%;height:20px;pointer-events:none;}
.wave-top2{position:absolute;top:-12px;left:0;width:100%;height:14px;pointer-events:none;opacity:.5;}
.liq-pct{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:21px;font-weight:900;letter-spacing:-.4px;z-index:2;
  text-shadow:0 1px 6px rgba(0,0,0,.35);
}

.g-amounts{
  display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:14px;
  background:var(--bg2);border-radius:14px;padding:12px;
  border:1px solid rgba(255,255,255,.04);
}
.ga{text-align:center;}
.ga-lb{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;}
.ga-v{font-size:14px;font-weight:800;}
.ga-v.sv{color:var(--green);}.ga-v.lf{color:var(--orange);}

.g-btns{display:flex;gap:8px;padding:0 18px 18px;}
.btn-dep{
  flex:1;height:46px;border-radius:14px;border:none;cursor:pointer;
  font-size:15px;font-weight:700;color:#fff;
  display:flex;align-items:center;justify-content:center;gap:7px;
  transition:opacity .15s,transform .12s;-webkit-tap-highlight-color:transparent;
}
.btn-dep:active{opacity:.8;transform:scale(.97);}
.btn-log{
  width:46px;height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.07);
  background:var(--bg2);color:var(--text2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:transform .12s;-webkit-tap-highlight-color:transparent;
}
.btn-log:active{transform:scale(.93);}
.btn-log svg{width:20px;height:20px;stroke-width:2;}

.dep-log{max-height:0;overflow:hidden;transition:max-height .35s cubic-bezier(.4,0,.2,1);border-top:1px solid rgba(255,255,255,.05);}
.dep-log.open{max-height:340px;overflow-y:auto;}
.dep-rows{padding:12px 18px;display:flex;flex-direction:column;gap:10px;}
.dr{display:flex;align-items:flex-start;gap:10px;}
.dr-ico{width:34px;height:34px;background:rgba(34,212,126,.1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.dr-msg{font-size:13px;font-weight:600;color:var(--text);line-height:1.4;}
.dr-dt{font-size:11px;color:var(--text3);margin-top:2px;}
.dr-a{font-size:13px;font-weight:800;color:var(--green);margin-left:auto;flex-shrink:0;}

/* FAB */
.fab{
  position:fixed;bottom:calc(var(--nav) + max(16px,var(--safe)) + 18px);right:20px;
  width:52px;height:52px;border-radius:16px;
  background:linear-gradient(135deg,var(--accent),var(--a2));
  border:none;cursor:pointer;z-index:89;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 24px rgba(124,109,255,.45);
  transition:transform .15s,opacity .2s;
  opacity:0;pointer-events:none;
  -webkit-tap-highlight-color:transparent;
}
.fab.show{opacity:1;pointer-events:all;}
.fab:active{transform:scale(.9);}
.fab svg{width:22px;height:22px;stroke:white;stroke-width:2.5;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.72);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  display:flex;align-items:flex-end;z-index:200;
  opacity:0;pointer-events:none;transition:opacity .22s;
}
.overlay.show{opacity:1;pointer-events:all;}
.sheet{
  width:100%;background:var(--bg1);
  border-radius:26px 26px 0 0;
  padding:0 22px;
  padding-bottom:max(32px,calc(var(--safe) + 16px));
  max-height:92dvh;overflow-y:auto;
  transform:translateY(100%);
  transition:transform .3s cubic-bezier(.32,1.2,.64,1);
  border:1px solid rgba(255,255,255,.08);border-bottom:none;
}
.overlay.show .sheet{transform:translateY(0);}
.s-handle{width:36px;height:4px;background:var(--bg3);border-radius:2px;margin:12px auto 22px;}
.s-title{font-size:21px;font-weight:900;text-align:center;margin-bottom:22px;letter-spacing:-.3px;}

.fl{font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;}
.fi{
  width:100%;padding:14px 16px;background:var(--bg2);
  border:1.5px solid rgba(255,255,255,.07);border-radius:var(--r2);
  font-size:16px;color:var(--text);outline:none;margin-bottom:18px;
  font-weight:600;transition:border-color .18s;
}
.fi:focus{border-color:var(--accent);}
.fi::placeholder{color:var(--text3);}

.emo-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px;}
.eb{
  width:48px;height:48px;border-radius:13px;border:2px solid transparent;
  background:var(--bg2);font-size:22px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:border-color .14s,transform .12s;
  -webkit-tap-highlight-color:transparent;
}
.eb.on{border-color:var(--accent);transform:scale(1.1);}

.col-row{display:flex;gap:10px;margin-bottom:22px;}
.cb{
  width:38px;height:38px;border-radius:50%;cursor:pointer;
  border:3px solid transparent;transition:border-color .14s,transform .12s;
  -webkit-tap-highlight-color:transparent;
}
.cb.on{border-color:#fff;transform:scale(1.18);}

.pbtn{
  width:100%;height:52px;border-radius:16px;border:none;cursor:pointer;
  font-size:17px;font-weight:800;color:#fff;
  background:linear-gradient(135deg,var(--accent),var(--a2));
  box-shadow:0 6px 20px rgba(124,109,255,.3);
  transition:opacity .15s,transform .1s;
  -webkit-tap-highlight-color:transparent;
}
.pbtn:active{transform:scale(.97);}
.sbtn2{
  width:100%;height:48px;border-radius:16px;border:1px solid rgba(255,255,255,.07);
  font-size:16px;font-weight:700;color:var(--text2);background:var(--bg2);
  cursor:pointer;margin-top:10px;-webkit-tap-highlight-color:transparent;
}

.big-inp{
  width:100%;font-size:44px;font-weight:900;text-align:center;
  background:none;border:none;outline:none;color:var(--text);
  border-bottom:2.5px solid var(--accent);padding-bottom:10px;margin-bottom:22px;
  letter-spacing:-1px;
}

/* CONFIRM SHEET */
.confirm-msg{font-size:16px;font-weight:600;line-height:1.55;color:var(--text2);text-align:center;margin-bottom:24px;}
.dbtn{
  width:100%;height:52px;border-radius:16px;border:none;cursor:pointer;
  font-size:17px;font-weight:800;color:#fff;background:var(--red);
  -webkit-tap-highlight-color:transparent;transition:opacity .15s;
}
.dbtn:active{opacity:.8;}

/* CELEBRATION */
.cel-ov{
  position:fixed;inset:0;z-index:300;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.65);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  opacity:0;pointer-events:none;transition:opacity .22s;
}
.cel-ov.show{opacity:1;pointer-events:all;}
.cel-card{
  background:var(--bg1);border-radius:28px;padding:32px 28px 24px;
  text-align:center;max-width:300px;width:90%;
  border:1px solid rgba(255,255,255,.09);
  box-shadow:0 24px 80px rgba(0,0,0,.6);
  animation:cpop .38s cubic-bezier(.34,1.56,.64,1);
}
.cel-emo{font-size:60px;display:block;margin-bottom:14px;}
.cel-msg{font-size:16px;font-weight:600;line-height:1.55;color:var(--text);}
.cel-btn{
  margin-top:20px;width:100%;height:48px;border-radius:14px;border:none;
  background:linear-gradient(135deg,var(--accent),var(--a2));color:#fff;
  font-size:16px;font-weight:800;cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.cf{position:fixed;pointer-events:none;z-index:301;border-radius:3px;animation:cfall linear forwards;}

/* â•â•â• EMPTY â•â•â• */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:35vh;gap:10px;text-align:center;padding:40px 24px;}
.empty .ei{font-size:52px;opacity:.55;}
.empty p{font-size:15px;font-weight:600;line-height:1.6;color:var(--text3);}

/* â•â•â• KEYFRAMES â•â•â• */
@keyframes mpop{from{opacity:0;transform:scale(.88) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes db{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
@keyframes cin{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes cpop{from{opacity:0;transform:scale(.68)}to{opacity:1;transform:scale(1)}}
@keyframes cfall{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(100vh) rotate(540deg)}}
</style>
</head>
<body>
<div id="app">

  <!-- â•â•â• CHAT â•â•â• -->
  <div class="screen active" id="s-chat">
    <div class="screen-body" style="flex:1;display:flex;flex-direction:column;overflow:hidden;padding-top:env(safe-area-inset-top,0px);">

      <!-- WELCOME (hidden when messages exist) -->
      <div class="chat-welcome" id="chatWelcome">
        <div class="cw-icon">ğŸ’¬</div>
        <div class="cw-title">Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº</div>
        <div class="cw-sub">ĞŸĞ¸ÑˆĞ¸ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ â€” Ñ€Ğ°Ğ·Ğ±ĞµÑ€Ñƒ Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑˆÑƒ. ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€:</div>
        <div class="cw-chips">
          <div class="cw-chip" onclick="fillInput('350 ĞºĞ¾Ñ„Ğµ Ğ¼Ğ°Ğº')">350 ĞºĞ¾Ñ„Ğµ Ğ¼Ğ°Ğº</div>
          <div class="cw-chip" onclick="fillInput('+85000 Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°')">+85000 Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°</div>
          <div class="cw-chip" onclick="fillInput('1200 Ñ‚Ğ°ĞºÑĞ¸')">1200 Ñ‚Ğ°ĞºÑĞ¸</div>
          <div class="cw-chip" onclick="fillInput('2400 Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹')">2400 Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹</div>
          <div class="cw-chip" onclick="fillInput('ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ Ğ¿Ğ¾Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ğ»?')">ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</div>
          <div class="cw-chip" onclick="fillInput('999 Spotify')">999 Spotify</div>
        </div>
      </div>

      <!-- MESSAGES -->
      <div class="msgs" id="msgs" style="display:none;"></div>

      <!-- INPUT -->
      <div class="chat-bar">
        <div class="inp-wrap">
          <textarea id="userInput" placeholder="350 ĞºĞ¾Ñ„Ğµ / +85000 Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°" rows="1"></textarea>
        </div>
        <button class="sbtn" id="sendBtn" onclick="sendMsg()">
          <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- â•â•â• STATS â•â•â• -->
  <div class="screen" id="s-stats">
    <div class="ph"><h1>ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°</h1><p id="statsMonth">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†</p></div>
    <div class="scr">
      <div style="padding:0 16px">
        <div class="sum-row">
          <div class="sc"><div class="lb">Ğ”Ğ¾Ñ…Ğ¾Ğ´Ñ‹</div><div class="vl inc" id="si">0 â‚½</div></div>
          <div class="sc"><div class="lb">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹</div><div class="vl exp" id="se">0 â‚½</div></div>
          <div class="sc"><div class="lb">Ğ˜Ñ‚Ğ¾Ğ³</div><div class="vl" id="sb">0 â‚½</div></div>
        </div>
        <div class="sec">ĞŸĞ¾ Ğ´Ğ½ÑĞ¼ â€” 7 Ğ´Ğ½ĞµĞ¹</div>
        <div class="ch-box"><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
        <div class="sec">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼</div>
        <div class="ch-box">
          <div class="ch-wrap"><canvas id="donutChart"></canvas></div>
          <div class="cat-list" id="catList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• HISTORY â•â•â• -->
  <div class="screen" id="s-history">
    <div class="ph"><h1>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</h1></div>
    <div style="padding:0 16px;flex-shrink:0;">
      <div class="filter-row" id="filterRow">
        <button class="ftag on" data-f="all" onclick="setFilter('all',this)">Ğ’ÑĞµ</button>
        <button class="ftag" data-f="expense" onclick="setFilter('expense',this)">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹</button>
        <button class="ftag" data-f="income" onclick="setFilter('income',this)">Ğ”Ğ¾Ñ…Ğ¾Ğ´Ñ‹</button>
        <button class="ftag" data-f="ĞšĞ°Ñ„Ğµ" onclick="setFilter('ĞšĞ°Ñ„Ğµ',this)">â˜• ĞšĞ°Ñ„Ğµ</button>
        <button class="ftag" data-f="ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹" onclick="setFilter('ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',this)">ğŸ›’ ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹</button>
        <button class="ftag" data-f="Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚" onclick="setFilter('Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚',this)">ğŸšŒ Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚</button>
        <button class="ftag" data-f="ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸" onclick="setFilter('ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',this)">ğŸ“± ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</button>
        <button class="ftag" data-f="Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ" onclick="setFilter('Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ',this)">ğŸ’Š Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ</button>
        <button class="ftag" data-f="Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ" onclick="setFilter('Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ',this)">ğŸ® Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ</button>
      </div>
    </div>
    <div class="scr" id="histEl" style="padding:0 16px 16px;margin-top:4px;"></div>
  </div>

  <!-- â•â•â• KOPILKA â•â•â• -->
  <div class="screen" id="s-kopilka">
    <div class="ph"><h1>ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸ ğŸ·</h1><p>Ğ¦ĞµĞ»Ğ¸ Ğ¸ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ</p></div>
    <div class="scr" id="goalsEl" style="padding:0 16px 16px;"></div>
  </div>

  <!-- FLOATING NAV -->
  <nav class="fnav">
    <button class="ni on" id="n-chat" onclick="go('chat',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      <span>Ğ§Ğ°Ñ‚</span>
    </button>
    <button class="ni" id="n-stats" onclick="go('stats',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      <span>Ğ“Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸</span>
    </button>
    <button class="ni" id="n-history" onclick="go('history',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <span>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</span>
    </button>
    <button class="ni" id="n-kopilka" onclick="go('kopilka',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 9a7 7 0 10-12.93 3.75L5 20h14l-1.07-7.25A7 7 0 0019 9z"/><path d="M9 9h.01M12 7v2"/></svg>
      <span>ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°</span>
    </button>
  </nav>

  <!-- FAB -->
  <button class="fab" id="fab" onclick="openGoalModal()">
    <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14"/></svg>
  </button>
</div>

<!-- â•â•â• MODALS â•â•â• -->

<!-- New Goal -->
<div class="overlay" id="mGoal">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title">ĞĞ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°</div>
    <div class="fl">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</div>
    <input class="fi" id="gName" placeholder="ĞÑ‚Ğ¿ÑƒÑĞº Ğ² ĞĞ¼ÑÑ‚ĞµÑ€Ğ´Ğ°Ğ¼Ğµ âœˆï¸">
    <div class="fl">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ñ†ĞµĞ»Ğ¸, â‚½</div>
    <input class="fi" id="gTarget" type="number" inputmode="numeric" placeholder="150 000">
    <div class="fl">Ğ˜ĞºĞ¾Ğ½ĞºĞ°</div>
    <div class="emo-grid" id="emoGrid"></div>
    <div class="fl">Ğ¦Ğ²ĞµÑ‚</div>
    <div class="col-row" id="colGrid"></div>
    <button class="pbtn" id="saveGoalBtn">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ ğŸ·</button>
    <button class="sbtn2" onclick="closeM('mGoal')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
  </div>
</div>

<!-- Deposit -->
<div class="overlay" id="mDep">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title" id="depTitle">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</div>
    <input class="big-inp" id="depAmt" type="number" inputmode="decimal" placeholder="0">
    <div class="fl">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</div>
    <input class="fi" id="depCmt" placeholder="ĞÑ‚ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°Ñ Ñ Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñ‹â€¦">
    <button class="pbtn" id="depBtn">ĞŸĞ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ ğŸ’°</button>
    <button class="sbtn2" onclick="closeM('mDep')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
  </div>
</div>

<!-- Confirm delete -->
<div class="overlay" id="mConfirm">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ?</div>
    <div class="confirm-msg" id="confirmMsg">Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹ Ğ±ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾.</div>
    <button class="dbtn" id="confirmBtn">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
    <button class="sbtn2" onclick="closeM('mConfirm')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
  </div>
</div>

<!-- Celebration -->
<div class="cel-ov" id="celOv">
  <div class="cel-card">
    <span class="cel-emo" id="celEmo">ğŸ‰</span>
    <div class="cel-msg" id="celMsg"></div>
    <button class="cel-btn" onclick="closeCel()">ĞĞ³Ğ¾Ğ½ÑŒ! ğŸ”¥</button>
  </div>
</div>

<script>
/* â”€â”€ TELEGRAM â”€â”€ */
const tg = window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();}

/* â”€â”€ DATA â”€â”€ */
let txs   = JSON.parse(localStorage.getItem('fin_tx')    || '[]');
let goals = JSON.parse(localStorage.getItem('fin_goals') || '[]');
let chatHistory = [];
let activeGoalId = null;
let pendingDeleteId = null;
let selEmo = 'ğŸ¯', selCol = '#7c6dff';
let activeFilter = 'all';

const ICONS = {'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹':'ğŸ›’','ĞšĞ°Ñ„Ğµ':'â˜•','Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚':'ğŸšŒ','ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸':'ğŸ“±','Ğ”Ğ¾Ğ¼':'ğŸ ','ĞĞ´ĞµĞ¶Ğ´Ğ°':'ğŸ‘•','Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ':'ğŸ’Š','Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ':'ğŸ®','ĞŸĞ¾Ğ´Ğ°Ñ€ĞºĞ¸':'ğŸ','Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°':'ğŸ’¼','Ğ¤Ñ€Ğ¸Ğ»Ğ°Ğ½Ñ':'ğŸ’»','ĞŸÑ€Ğ¾Ñ‡ĞµĞµ':'ğŸ“¦'};
const PAL  = ['#7c6dff','#22d47e','#ffb347','#ff4d6d','#a78bfa','#3b82f6','#ec4899','#14b8a6','#f97316','#6366f1'];
const EMOJIS = ['ğŸ¯','âœˆï¸','ğŸ–','ğŸš—','ğŸ ','ğŸ’»','ğŸ“±','ğŸ“','ğŸ’','ğŸ‹ï¸','ğŸ¸','ğŸŒ','ğŸ‘¶','ğŸ•','ğŸ’','âŒš','ğŸ®','ğŸ“·'];
const COLS   = ['#7c6dff','#22d47e','#ffb347','#ff4d6d','#a78bfa','#3b82f6','#ec4899','#14b8a6'];

const save  = ()=> localStorage.setItem('fin_tx',    JSON.stringify(txs));
const saveG = ()=> localStorage.setItem('fin_goals', JSON.stringify(goals));
const fmt   = n  => n.toLocaleString('ru') + ' â‚½';
const now   = ()=> new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});

/* â”€â”€ NAV â”€â”€ */
function go(name, btn){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(b=>b.classList.remove('on'));
  document.getElementById('s-'+name).classList.add('active');
  btn.classList.add('on');
  document.getElementById('fab').classList.toggle('show', name==='kopilka');
  if(name==='stats')   renderStats();
  if(name==='history') renderHistory();
  if(name==='kopilka') renderGoals();
}

/* â”€â”€ CHAT â”€â”€ */
const msgsEl   = document.getElementById('msgs');
const welcomeEl= document.getElementById('chatWelcome');
const inpEl    = document.getElementById('userInput');
const sbtn     = document.getElementById('sendBtn');

function fillInput(txt){ inpEl.value=txt; inpEl.focus(); }

function showMsgs(){
  welcomeEl.style.display='none';
  msgsEl.style.display='flex';
}

function addMsg(role, text, tx){
  showMsgs();
  const d = document.createElement('div');
  d.className = 'msg '+role;
  let h = `<div class="bbl">${text}`;
  if(tx){
    const plus=tx.type==='income';
    const ico=ICONS[tx.category]||'ğŸ’°';
    h+=`<div class="tx-card"><div class="tx-ico">${ico}</div><div class="tx-b"><div class="tx-d">${tx.description}</div><div class="tx-c">${tx.category}</div></div><div class="tx-s ${tx.type}">${plus?'+':'-'}${tx.amount.toLocaleString('ru')} â‚½</div></div>`;
  }
  h+=`</div><div class="mtime">${now()}</div>`;
  d.innerHTML=h;
  msgsEl.appendChild(d);
  msgsEl.scrollTop=msgsEl.scrollHeight;
}
function showTyping(){ showMsgs(); const d=document.createElement('div');d.className='msg b';d.id='typing';d.innerHTML=`<div class="typing-row"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;msgsEl.appendChild(d);msgsEl.scrollTop=msgsEl.scrollHeight; }
function hideTyping(){ document.getElementById('typing')?.remove(); }

inpEl.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';});
inpEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});

// State for multi-step kopilka dialogs
let pendingKopilkaDeposit = null; // {amount, waitingForGoal: true}
let pendingKopilkaCreate  = null; // waiting for confirmation

async function sendMsg(){
  const t=inpEl.value.trim();
  if(!t||sbtn.disabled) return;
  addMsg('u',t);
  inpEl.value='';inpEl.style.height='auto';
  sbtn.disabled=true;showTyping();

  // â”€â”€ Handle pending multi-step dialogs â”€â”€
  if(pendingKopilkaDeposit){
    const g=goals.find(g=>g.name.toLowerCase().includes(t.toLowerCase())||t.toLowerCase().includes(g.name.toLowerCase()));
    if(g){
      const {amount}=pendingKopilkaDeposit;
      pendingKopilkaDeposit=null;
      await doKopilkaDeposit(g,amount);
      sbtn.disabled=false;return;
    } else {
      hideTyping();
      addMsg('b','ĞĞµ Ğ½Ğ°ÑˆÑ‘Ğ» Ñ‚Ğ°ĞºÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ ğŸ¤” ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°:\n'+goals.map(g=>`â€¢ ${g.emoji} ${g.name}`).join('\n'));
      sbtn.disabled=false;return;
    }
  }

  chatHistory.push({role:'user',content:t});

  const goalsInfo = goals.length
    ? `\nĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: ${JSON.stringify(goals.map(g=>({id:g.id,name:g.name,emoji:g.emoji,saved:g.saved,target:g.target})))}`
    : '\nĞšĞ¾Ğ¿Ğ¸Ğ»Ğ¾Ğº Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚.';

  const GOAL_EMOJI_MAP = `
ĞŸĞ¾Ğ´Ğ±Ğ¸Ñ€Ğ°Ñ emoji Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚:
Ğ¿ÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸Ğµ/Ğ¾Ñ‚Ğ¿ÑƒÑĞº/Ğ¼Ğ¾Ñ€Ğµ â†’ âœˆï¸ Ğ¸Ğ»Ğ¸ ğŸ–
Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ°/Ğ°Ğ²Ñ‚Ğ¾ â†’ ğŸš—
Ğ´Ğ¾Ğ¼/ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°/Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚ â†’ ğŸ 
Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½/Ğ³Ğ°Ğ´Ğ¶ĞµÑ‚ â†’ ğŸ“±
Ğ½Ğ¾ÑƒÑ‚Ğ±ÑƒĞº/ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€ â†’ ğŸ’»
Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ/ÑƒÑ‡Ñ‘Ğ±Ğ° â†’ ğŸ“
ÑĞ²Ğ°Ğ´ÑŒĞ±Ğ°/ĞºĞ¾Ğ»ÑŒÑ†Ğ¾ â†’ ğŸ’
ÑĞ¿Ğ¾Ñ€Ñ‚/Ñ„Ğ¸Ñ‚Ğ½ĞµÑ â†’ ğŸ‹ï¸
Ğ¼ÑƒĞ·Ñ‹ĞºĞ° â†’ ğŸ¸
Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº â†’ ğŸ
Ğ´ĞµĞ½ÑŒĞ³Ğ¸/Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ â†’ ğŸ’°
Ğ¿Ğ¸Ñ‚Ğ¾Ğ¼ĞµÑ† â†’ ğŸ•
Ñ€ĞµĞ±Ñ‘Ğ½Ğ¾Ğº â†’ ğŸ‘¶
Ñ‡Ğ°ÑÑ‹/ÑƒĞºÑ€Ğ°ÑˆĞµĞ½Ğ¸Ñ â†’ âŒš
Ğ¸Ğ³Ñ€Ñ‹ â†’ ğŸ®
Ğ¦Ğ²ĞµÑ‚: Ğ¿ÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸Ğµâ†’#7c6dff, Ğ¿Ñ€Ğ¸Ñ€Ğ¾Ğ´Ğ°/Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµâ†’#22d47e, ĞµĞ´Ğ°â†’#ffb347, ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµâ†’#ff4d6d, Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸â†’#3b82f6, Ñ‚Ğ²Ğ¾Ñ€Ñ‡ĞµÑÑ‚Ğ²Ğ¾â†’#ec4899, Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñâ†’#7c6dff`;

  const sys=`Ğ¢Ñ‹ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ² Telegram WebApp.${goalsInfo}

Ğ£ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹. Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ ĞĞ”Ğ˜Ğ Ğ±Ğ»Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:

1) ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ:
<TX>{"type":"expense"|"income","amount":Ñ‡Ğ¸ÑĞ»Ğ¾,"description":"Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ","category":"ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹|ĞšĞ°Ñ„Ğµ|Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚|ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸|Ğ”Ğ¾Ğ¼|ĞĞ´ĞµĞ¶Ğ´Ğ°|Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ|Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ|ĞŸĞ¾Ğ´Ğ°Ñ€ĞºĞ¸|Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°|Ğ¤Ñ€Ğ¸Ğ»Ğ°Ğ½Ñ|ĞŸÑ€Ğ¾Ñ‡ĞµĞµ"}</TX>

2) ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ (ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ "Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ X Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ Y" Ğ¸Ğ»Ğ¸ "Ğ·Ğ°ĞºĞ¸Ğ½ÑŒ X Ğ² Y"):
<KOPILKA_DEP>{"goalId":Ñ‡Ğ¸ÑĞ»Ğ¾_Ğ¸Ğ»Ğ¸_null,"goalName":"Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ null","amount":Ñ‡Ğ¸ÑĞ»Ğ¾}</KOPILKA_DEP>
Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾ Ğ² ĞºĞ°ĞºÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ â€” ÑÑ‚Ğ°Ğ²ÑŒ goalId:null Ğ¸ goalName:null

3) Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ (ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ "ÑĞ¾Ğ·Ğ´Ğ°Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ" Ğ¸Ğ»Ğ¸ "Ğ½Ğ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°"):
<KOPILKA_NEW>{"name":"Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ","target":Ñ‡Ğ¸ÑĞ»Ğ¾,"emoji":"Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ emoji","color":"hex Ñ†Ğ²ĞµÑ‚"}</KOPILKA_NEW>
${GOAL_EMOJI_MAP}

Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ â€” Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ Ğ±Ğ»Ğ¾Ğº.
ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸, ĞºÑ€Ğ°Ñ‚ĞºĞ¾, Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ½Ğ¾ (1-2 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ).`;

  try{
    const r = await fetch('https://finance-backend-381v.onrender.com/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ message: t })
});

const data = await r.json();
const full = data.text || '';
;
    chatHistory.push({role:'assistant',content:full});
    hideTyping();
    await processAIResponse(full, t);
  }catch(e){
    hideTyping();
    await processFallback(t);
  }
  sbtn.disabled=false;
}

async function processAIResponse(full, originalText){
  let disp = full;

  // â”€â”€ KOPILKA_NEW â”€â”€
  const newM = full.match(/<KOPILKA_NEW>([\s\S]*?)<\/KOPILKA_NEW>/);
  if(newM){
    try{
      const d = JSON.parse(newM[1].trim());
      disp = full.replace(/<KOPILKA_NEW>[\s\S]*?<\/KOPILKA_NEW>/,'').trim();
      createGoal(d.name, d.target, d.emoji||'ğŸ¯', d.color||'#7c6dff');
      addMsg('b', disp||`ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ° Â«${d.name}Â» ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°! ğŸ·`);
      // Switch to kopilka tab after short delay
      setTimeout(()=>{
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.ni').forEach(b=>b.classList.remove('on'));
        document.getElementById('s-kopilka').classList.add('active');
        document.getElementById('n-kopilka').classList.add('on');
        document.getElementById('fab').classList.add('show');
        renderGoals();
      },800);
      return;
    }catch(e){}
  }

  // â”€â”€ KOPILKA_DEP â”€â”€
  const depM = full.match(/<KOPILKA_DEP>([\s\S]*?)<\/KOPILKA_DEP>/);
  if(depM){
    try{
      const d = JSON.parse(depM[1].trim());
      disp = full.replace(/<KOPILKA_DEP>[\s\S]*?<\/KOPILKA_DEP>/,'').trim();
      if(!goals.length){
        addMsg('b','Ğ£ Ñ‚ĞµĞ±Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ĞºĞ¾Ğ¿Ğ¸Ğ»Ğ¾Ğº. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¿ĞµÑ€Ğ²ÑƒÑ! ğŸ·');return;
      }
      // Find goal
      let g = null;
      if(d.goalId) g = goals.find(x=>x.id===d.goalId);
      if(!g && d.goalName) g = goals.find(x=>x.name.toLowerCase().includes(d.goalName.toLowerCase()));
      if(!g && goals.length===1) g = goals[0]; // only one â€” use it

      if(g){
        addMsg('b', disp||`Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ ${d.amount.toLocaleString('ru')} â‚½ Ğ² Â«${g.name}Â»...`);
        await doKopilkaDeposit(g, d.amount);
      } else {
        // Ask which goal
        pendingKopilkaDeposit = {amount: d.amount};
        addMsg('b', `Ğ’ ĞºĞ°ĞºÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ${d.amount.toLocaleString('ru')} â‚½? Ğ£ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ:\n`+goals.map(g=>`${g.emoji} ${g.name}`).join('\n'));
      }
      return;
    }catch(e){}
  }

  // â”€â”€ TX â”€â”€
  const txM = full.match(/<TX>([\s\S]*?)<\/TX>/);
  if(txM){
    try{
      const txData=JSON.parse(txM[1].trim());
      disp=full.replace(/<TX>[\s\S]*?<\/TX>/,'').trim();
      txs.unshift({id:Date.now(),...txData,date:new Date().toISOString()});save();
      addMsg('b',disp||'ğŸ‘',txData);return;
    }catch(e){}
  }

  addMsg('b', disp||'ğŸ‘');
}

async function doKopilkaDeposit(g, amount){
  const prev=g.saved;
  g.saved+=amount;
  const msg=await genMotiv(g,amount,prev,'');
  if(!g.deposits)g.deposits=[];
  g.deposits.push({amount,date:new Date().toISOString(),aiMessage:msg});
  saveG();renderGoals();celebrate(g,msg);
}

async function processFallback(t){
  const l=t.toLowerCase(),n=t.match(/[\d\s]+/),a=n?+n[0].replace(/\s/g,''):300;

  // kopilka create fallback
  if(/ÑĞ¾Ğ·Ğ´Ğ°Ğ¹|Ğ½Ğ¾Ğ²ÑƒÑ|Ğ½Ğ¾Ğ²Ğ°Ñ|ĞºĞ¾Ğ¿Ğ¸Ğ»Ğº/.test(l)){
    const nameM=t.match(/ĞºĞ¾Ğ¿Ğ¸Ğ»Ğº[ÑƒĞ°]?\s+[Â«"]?(.+?)[Â»"]?(\s+Ğ½Ğ°\s+|$)/i);
    const amtM=t.match(/(\d[\d\s]*)\s*(â‚½|Ñ€ÑƒĞ±|Ñ‚Ñ‹Ñ|Ğº\b)?/i);
    if(nameM){
      const name=nameM[1].trim();
      const amt=amtM?+amtM[1].replace(/\s/g,''):50000;
      createGoal(name,amt,'ğŸ¯','#7c6dff');
      addMsg('b',`Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ» ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ Â«${name}Â» Ñ Ñ†ĞµĞ»ÑŒÑ ${amt.toLocaleString('ru')} â‚½ ğŸ·`);
      setTimeout(()=>{document.getElementById('n-kopilka').click();},600);
      return;
    }
  }
  // kopilka deposit fallback
  if(/Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ|Ğ·Ğ°ĞºĞ¸Ğ½ÑŒ|Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½|Ğ¾Ñ‚Ğ»Ğ¾Ğ¶Ğ¸/.test(l)&&/ĞºĞ¾Ğ¿Ğ¸Ğ»Ğº/.test(l)){
    if(!goals.length){addMsg('b','ĞĞµÑ‚ ĞºĞ¾Ğ¿Ğ¸Ğ»Ğ¾Ğº. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¿ĞµÑ€Ğ²ÑƒÑ! ğŸ·');return;}
    const amtM=t.match(/(\d[\d\s]*)/);
    const amt=amtM?+amtM[1].replace(/\s/g,''):1000;
    if(goals.length===1){await doKopilkaDeposit(goals[0],amt);return;}
    pendingKopilkaDeposit={amount:amt};
    addMsg('b',`Ğ’ ĞºĞ°ĞºÑƒÑ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ${amt.toLocaleString('ru')} â‚½?\n`+goals.map(g=>`${g.emoji} ${g.name}`).join('\n'));
    return;
  }

  if(/Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°|Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»|Ğ´Ğ¾Ñ…Ğ¾Ğ´|Ñ„Ñ€Ğ¸Ğ»Ğ°Ğ½Ñ/.test(l)){addMsg('b','Ğ”Ğ¾Ñ…Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ»! ğŸ’ª',{type:'income',amount:a,description:t,category:'Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°'});txs.unshift({id:Date.now(),type:'income',amount:a,description:t,category:'Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°',date:new Date().toISOString()});save();return;}
  if(/ĞºĞ¾Ñ„Ğµ|Ñ‡Ğ°Ğ¹|Ğ»Ğ°Ñ‚Ñ‚Ğµ/.test(l)){addMsg('b','ĞšĞ¾Ñ„Ğµ â˜•',{type:'expense',amount:a,description:t,category:'ĞšĞ°Ñ„Ğµ'});txs.unshift({id:Date.now(),type:'expense',amount:a,description:t,category:'ĞšĞ°Ñ„Ğµ',date:new Date().toISOString()});save();return;}
  if(/Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚|Ğ¼Ğ°Ğ³Ğ°Ğ·/.test(l)){addMsg('b','ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹ ğŸ›’',{type:'expense',amount:a,description:t,category:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹'});txs.unshift({id:Date.now(),type:'expense',amount:a,description:t,category:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',date:new Date().toISOString()});save();return;}
  if(/Ñ‚Ğ°ĞºÑĞ¸|Ğ¼ĞµÑ‚Ñ€Ğ¾|Ğ°Ğ²Ñ‚Ğ¾Ğ±ÑƒÑ/.test(l)){addMsg('b','Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚ ğŸšŒ',{type:'expense',amount:a,description:t,category:'Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚'});txs.unshift({id:Date.now(),type:'expense',amount:a,description:t,category:'Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚',date:new Date().toISOString()});save();return;}
  const def={type:'expense',amount:a,description:t,category:'ĞŸÑ€Ğ¾Ñ‡ĞµĞµ'};
  addMsg('b','Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ğ»! ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸ API Ğ´Ğ»Ñ ÑƒĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€Ğ° ğŸ‘',def);
  txs.unshift({id:Date.now(),...def,date:new Date().toISOString()});save();
}

/* â”€â”€ STATS â”€â”€ */
let bI=null,dI=null;
function renderStats(){
  const ms=new Date();ms.setDate(1);ms.setHours(0,0,0,0);
  const mt=txs.filter(t=>new Date(t.date)>=ms);
  const inc=mt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp=mt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  document.getElementById('si').textContent=fmt(inc);
  document.getElementById('se').textContent=fmt(exp);
  const bl=document.getElementById('sb');
  const bal=inc-exp;
  bl.textContent=(bal>=0?'+':'')+fmt(bal);
  bl.style.color=bal>=0?'var(--green)':'var(--red)';
  const mn=new Date().toLocaleDateString('ru',{month:'long',year:'numeric'});
  document.getElementById('statsMonth').textContent=mn.charAt(0).toUpperCase()+mn.slice(1);

  const gc='rgba(255,255,255,.05)',tc='#44445a';
  const days=[],de=[],di=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(d.toLocaleDateString('ru',{weekday:'short'}));const ds=d.toDateString();const dx=txs.filter(t=>new Date(t.date).toDateString()===ds);de.push(dx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));di.push(dx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));}
  if(bI)bI.destroy();
  bI=new Chart(document.getElementById('barChart'),{type:'bar',data:{labels:days,datasets:[{label:'Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹',data:de,backgroundColor:'rgba(255,77,109,.7)',borderRadius:7,borderSkipped:false},{label:'Ğ”Ğ¾Ñ…Ğ¾Ğ´Ñ‹',data:di,backgroundColor:'rgba(34,212,126,.7)',borderRadius:7,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:tc,font:{size:11,weight:'bold'},boxWidth:10,padding:12}}},scales:{x:{grid:{color:gc},ticks:{color:tc,font:{weight:'bold'}}},y:{grid:{color:gc},ticks:{color:tc,callback:v=>v?v.toLocaleString('ru'):0}}}}});
  const cm={};mt.filter(t=>t.type==='expense').forEach(t=>{cm[t.category]=(cm[t.category]||0)+t.amount;});
  const cats=Object.entries(cm).sort((a,b)=>b[1]-a[1]);
  const mx=cats[0]?.[1]||1;
  if(dI)dI.destroy();
  if(cats.length)dI=new Chart(document.getElementById('donutChart'),{type:'doughnut',data:{labels:cats.map(c=>c[0]),datasets:[{data:cats.map(c=>c[1]),backgroundColor:PAL,borderWidth:0,hoverOffset:10}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{display:false}}}});
  document.getElementById('catList').innerHTML=cats.map((c,i)=>`<div class="cr"><div class="cdot" style="background:${PAL[i%PAL.length]}"></div><div class="cn">${ICONS[c[0]]||'â€¢'} ${c[0]}</div><div class="ct"><div class="cf" style="width:0%;background:${PAL[i%PAL.length]}" data-w="${(c[1]/mx*100).toFixed(0)}"></div></div><div class="ca">${fmt(c[1])}</div></div>`).join('');
  setTimeout(()=>document.querySelectorAll('.cf').forEach(el=>{el.style.width=el.dataset.w+'%';}),60);
}

/* â”€â”€ HISTORY â”€â”€ */
function setFilter(f, btn){
  activeFilter=f;
  document.querySelectorAll('.ftag').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderHistory();
}
function renderHistory(){
  const el=document.getElementById('histEl');
  let data=txs;
  if(activeFilter==='expense') data=txs.filter(t=>t.type==='expense');
  else if(activeFilter==='income') data=txs.filter(t=>t.type==='income');
  else if(activeFilter!=='all') data=txs.filter(t=>t.category===activeFilter);

  if(!data.length){el.innerHTML=`<div class="empty"><div class="ei">ğŸ“­</div><p>ĞĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹<br>Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼</p></div>`;return;}
  const g={};
  data.forEach(t=>{const k=new Date(t.date).toLocaleDateString('ru',{day:'numeric',month:'long'});if(!g[k])g[k]=[];g[k].push(t);});
  el.innerHTML=Object.entries(g).map(([d,ts])=>`<div class="day-g"><div class="day-lb">${d}</div><div class="day-items">${ts.map(t=>`<div class="hi"><div class="hi-ico ${t.type}">${ICONS[t.category]||'ğŸ’°'}</div><div class="hi-info"><div class="hi-d">${t.description}</div><div class="hi-c">${t.category}</div></div><div class="hi-a ${t.type}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString('ru')} â‚½</div></div>`).join('')}</div></div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KOPILKA â€” FULLY FIXED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGoals(){
  const el=document.getElementById('goalsEl');
  if(!goals.length){el.innerHTML=`<div class="empty"><div class="ei">ğŸ·</div><p>ĞĞµÑ‚ ĞºĞ¾Ğ¿Ğ¸Ğ»Ğ¾Ğº.<br>ĞĞ°Ğ¶Ğ¼Ğ¸ + Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²ÑƒÑ!</p></div>`;return;}
  el.innerHTML=goals.map(g=>goalHTML(g)).join('');
  // Animate fills after paint
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    goals.forEach(g=>{
      const el=document.getElementById('lf-'+g.id);
      if(el) el.style.height=Math.min(g.saved/g.target*100,100)+'%';
    });
  }));
}

function goalHTML(g){
  const pct=Math.min(g.saved/g.target*100,100);
  const left=Math.max(g.target-g.saved,0);
  const txtCol=pct>45?'#fff':'var(--text)';
  const deps=(g.deposits||[]).slice().reverse();
  return `
<div class="goal-card" id="gc-${g.id}">
  <div class="g-inner">
    <div class="g-head">
      <div class="g-emo" style="background:${g.color}22">${g.emoji}</div>
      <div><div class="g-name">${g.name}</div><div class="g-sub">Ğ¦ĞµĞ»ÑŒ: ${g.target.toLocaleString('ru')} â‚½</div></div>
      <button class="g-del" data-id="${g.id}" aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
      </button>
    </div>

    <div class="liq-wrap">
      <div class="liq-fill" id="lf-${g.id}" style="height:0%;background:${g.color}">
        <svg class="wave-top" viewBox="0 0 400 20" preserveAspectRatio="none">
          <path fill="${g.color}">
            <animate attributeName="d" dur="3s" repeatCount="indefinite"
              values="M0,10 C100,0 200,20 300,10 C350,5 380,15 400,10 L400,20 L0,20 Z;
                      M0,12 C100,4 200,18 300,12 C350,7 380,13 400,12 L400,20 L0,20 Z;
                      M0,10 C100,0 200,20 300,10 C350,5 380,15 400,10 L400,20 L0,20 Z"/>
          </path>
        </svg>
        <svg class="wave-top2" viewBox="0 0 400 14" preserveAspectRatio="none">
          <path fill="${g.color}">
            <animate attributeName="d" dur="4.5s" repeatCount="indefinite"
              values="M0,7 C80,0 160,14 240,7 C320,0 360,14 400,7 L400,14 L0,14 Z;
                      M0,9 C80,2 160,12 240,9 C320,2 360,12 400,9 L400,14 L0,14 Z;
                      M0,7 C80,0 160,14 240,7 C320,0 360,14 400,7 L400,14 L0,14 Z"/>
          </path>
        </svg>
      </div>
      <div class="liq-pct" style="color:${txtCol}">${pct>=100?'ğŸ‰':pct.toFixed(1)+'%'}</div>
    </div>

    <div class="g-amounts">
      <div class="ga"><div class="ga-lb">ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾</div><div class="ga-v sv">${fmt(g.saved)}</div></div>
      <div class="ga"><div class="ga-lb">ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ</div><div class="ga-v lf">${left>0?fmt(left):'âœ…'}</div></div>
      <div class="ga"><div class="ga-lb">Ğ¦ĞµĞ»ÑŒ</div><div class="ga-v">${fmt(g.target)}</div></div>
    </div>
  </div>

  <div class="g-btns">
    <button class="btn-dep" style="background:${g.color}" data-dep="${g.id}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ
    </button>
    <button class="btn-log" data-log="${g.id}" aria-label="Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    </button>
  </div>

  <div class="dep-log" id="dl-${g.id}">
    <div class="dep-rows">
      ${deps.length?deps.map(d=>`<div class="dr"><div class="dr-ico">ğŸ’°</div><div style="flex:1"><div class="dr-msg">${d.aiMessage||'+'+d.amount.toLocaleString('ru')+' â‚½'}</div><div class="dr-dt">${new Date(d.date).toLocaleDateString('ru',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</div></div><div class="dr-a">+${d.amount.toLocaleString('ru')} â‚½</div></div>`).join('') : '<p style="text-align:center;color:var(--text3);font-size:13px;padding:8px 0;font-weight:600">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</p>'}
    </div>
  </div>
</div>`;
}

// Event delegation for goal buttons â€” works correctly
document.getElementById('goalsEl').addEventListener('click', function(e){
  // DELETE
  const delBtn = e.target.closest('[data-id]');
  if(delBtn){
    e.stopPropagation();
    const id = +delBtn.dataset.id;
    const g = goals.find(x=>x.id===id);
    if(!g) return;
    pendingDeleteId = id;
    document.getElementById('confirmMsg').textContent = `Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ Â«${g.name}Â»? Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹.`;
    openM('mConfirm');
    return;
  }
  // DEPOSIT
  const depBtn = e.target.closest('[data-dep]');
  if(depBtn){
    e.stopPropagation();
    openDeposit(+depBtn.dataset.dep);
    return;
  }
  // LOG TOGGLE
  const logBtn = e.target.closest('[data-log]');
  if(logBtn){
    e.stopPropagation();
    const id = logBtn.dataset.log;
    document.getElementById('dl-'+id)?.classList.toggle('open');
  }
});

// Confirm delete
document.getElementById('confirmBtn').addEventListener('click', function(){
  if(pendingDeleteId){
    goals = goals.filter(g=>g.id!==pendingDeleteId);
    saveG();
    pendingDeleteId=null;
    closeM('mConfirm');
    renderGoals();
  }
});

/* â”€â”€ GOAL MODAL â”€â”€ */
function openGoalModal(){
  selEmo='ğŸ¯'; selCol='#7c6dff';
  document.getElementById('gName').value='';
  document.getElementById('gTarget').value='';
  document.getElementById('emoGrid').innerHTML=EMOJIS.map(e=>`<div class="eb${e===selEmo?' on':''}" data-emo="${e}">${e}</div>`).join('');
  document.getElementById('colGrid').innerHTML=COLS.map(c=>`<div class="cb${c===selCol?' on':''}" style="background:${c}" data-col="${c}"></div>`).join('');
  openM('mGoal');
}

// Emoji & color pickers â€” event delegation
document.getElementById('emoGrid').addEventListener('click',function(e){
  const el=e.target.closest('.eb');if(!el)return;
  selEmo=el.dataset.emo;
  document.querySelectorAll('.eb').forEach(x=>x.classList.remove('on'));
  el.classList.add('on');
});
document.getElementById('colGrid').addEventListener('click',function(e){
  const el=e.target.closest('.cb');if(!el)return;
  selCol=el.dataset.col;
  document.querySelectorAll('.cb').forEach(x=>x.classList.remove('on'));
  el.classList.add('on');
});

document.getElementById('saveGoalBtn').addEventListener('click', function(){
  const name=document.getElementById('gName').value.trim();
  const rawTarget=document.getElementById('gTarget').value.replace(/\s/g,'').replace(/,/g,'.');
  const target=parseFloat(rawTarget);
  if(!name){document.getElementById('gName').focus();return;}
  if(!target||target<=0){document.getElementById('gTarget').focus();return;}
  createGoal(name,target,selEmo,selCol);
  closeM('mGoal');
});

function createGoal(name,target,emoji,color){
  const g={id:Date.now(),name,target,emoji,color,saved:0,deposits:[]};
  goals.push(g);saveG();renderGoals();
  if(document.getElementById('s-kopilka').classList.contains('active'))renderGoals();
}

/* â”€â”€ DEPOSIT â”€â”€ */
function openDeposit(id){
  activeGoalId=id;
  const g=goals.find(x=>x.id===id);if(!g)return;
  document.getElementById('depTitle').textContent=g.emoji+' '+g.name;
  document.getElementById('depAmt').value='';
  document.getElementById('depCmt').value='';
  openM('mDep');
  setTimeout(()=>document.getElementById('depAmt').focus(),350);
}

document.getElementById('depBtn').addEventListener('click', async function(){
  const rawAmt=document.getElementById('depAmt').value.replace(/\s/g,'').replace(/,/g,'.');
  const amount=parseFloat(rawAmt);
  if(!amount||amount<=0){document.getElementById('depAmt').focus();return;}
  const cmt=document.getElementById('depCmt').value.trim();
  const g=goals.find(x=>x.id===activeGoalId);if(!g)return;
  const prev=g.saved;
  g.saved+=amount;
  closeM('mDep');
  const msg=await genMotiv(g,amount,prev,cmt);
  if(!g.deposits)g.deposits=[];
  g.deposits.push({amount,date:new Date().toISOString(),comment:cmt,aiMessage:msg});
  saveG();renderGoals();celebrate(g,msg);
});

async function genMotiv(g, amount, prev, cmt) {
  const pct = (g.saved / g.target * 100).toFixed(1);
  const diff = ((g.saved - prev) / g.target * 100).toFixed(1);

  const prompt = `ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ğ» ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ Â«${g.name}Â» Ğ½Ğ° ${amount.toLocaleString('ru')} â‚½.
Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ${g.saved.toLocaleString('ru')} Ğ¸Ğ· ${g.target.toLocaleString('ru')} â‚½
(${pct}%, +${diff}%).${cmt ? ' ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹: ' + cmt : ''}

ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ĞĞ”ĞĞ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (1-2 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ). Ğ¡Ñ‚Ğ¸Ğ»ÑŒ: Ğ´ĞµÑ€Ğ·ĞºĞ¸Ğ¹, Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ½Ñ‹Ğ¹. Ğ‘ĞµĞ· Ğ²ÑÑ‚ÑƒĞ¿Ğ»ĞµĞ½Ğ¸Ğ¹.`;

  try {
    const r = await fetch('https://finance-backend-381v.onrender.com/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: prompt })
    });

    const d = await r.json();
    return (d.text || '').trim() || fallMotiv(g, amount, pct, diff);

  } catch (e) {
    return fallMotiv(g, amount, pct, diff);
  }
}

/* â”€â”€ CELEBRATION â”€â”€ */
function celebrate(g,msg){
  document.getElementById('celEmo').textContent=g.emoji;
  document.getElementById('celMsg').textContent=msg;
  document.getElementById('celOv').classList.add('show');
  spawnConfetti(g.color);
}
function closeCel(){document.getElementById('celOv').classList.remove('show');}
document.getElementById('celOv').addEventListener('click',function(e){if(e.target===this)closeCel();});

function spawnConfetti(col){
  const cols=[col,'#fbbf24','#34d399','#f472b6','#fff','#a78bfa'];
  for(let i=0;i<60;i++)setTimeout(()=>{
    const el=document.createElement('div');
    el.className='cf';
    el.style.cssText=`left:${Math.random()*100}vw;top:-14px;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;background:${cols[~~(Math.random()*cols.length)]};border-radius:${Math.random()>.5?'50%':'3px'};animation-duration:${1.6+Math.random()*2}s;animation-delay:${Math.random()*.5}s;`;
    document.body.appendChild(el);setTimeout(()=>el.remove(),3200);
  },i*20);
}

/* â”€â”€ MODAL UTILS â”€â”€ */
function openM(id){ document.getElementById(id).classList.add('show'); }
function closeM(id){ document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.overlay').forEach(m=>{
  m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('show'); });
});

/* â”€â”€ DEMO DATA â”€â”€ */
if(!txs.length){
  [{type:'expense',amount:350,description:'ĞºĞ¾Ñ„Ğµ Ğ¼Ğ°Ğº',category:'ĞšĞ°Ñ„Ğµ',date:new Date(Date.now()-86400000).toISOString()},
   {type:'expense',amount:2400,description:'Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹ Ğ’ĞºÑƒÑĞ²Ğ¸Ğ»Ğ»',category:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',date:new Date(Date.now()-86400000*2).toISOString()},
   {type:'income',amount:85000,description:'Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¼Ğ°Ñ€Ñ‚',category:'Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°',date:new Date(Date.now()-86400000*3).toISOString()},
   {type:'expense',amount:999,description:'Spotify',category:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',date:new Date(Date.now()-86400000*3).toISOString()},
   {type:'expense',amount:1200,description:'Ñ‚Ğ°ĞºÑĞ¸ Ğ´Ğ¾Ğ¼Ğ¾Ğ¹',category:'Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚',date:new Date(Date.now()-86400000*4).toISOString()},
  ].forEach((d,i)=>txs.push({id:Date.now()+i,...d}));
  save();
}
if(!goals.length){
  goals=[
    {id:1,name:'ĞÑ‚Ğ¿ÑƒÑĞº Ğ² Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ğ¸',target:150000,emoji:'âœˆï¸',color:'#7c6dff',saved:47000,deposits:[
      {amount:20000,date:new Date(Date.now()-86400000*10).toISOString(),aiMessage:'Ğ®Ñ…ÑƒÑƒ! +13.3% â€” Ñ‚Ñ‹ ĞºÑ€Ğ°ÑĞ°Ğ²Ñ‡Ğ¸Ğº! 31% Ğ´Ğ¾ Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ğ¸ Ğ² ĞºĞ°Ñ€Ğ¼Ğ°Ğ½Ğµ ğŸ”¥'},
      {amount:15000,date:new Date(Date.now()-86400000*5).toISOString(),aiMessage:'Ğ•Ñ‰Ñ‘ 15Ğº Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ â€” 41% Ğ¿ÑƒÑ‚Ğ¸. Ğ‘Ğ°Ñ€ÑĞµĞ»Ğ¾Ğ½Ğ° Ğ¶Ğ´Ñ‘Ñ‚! ğŸ‡ªğŸ‡¸'},
      {amount:12000,date:new Date(Date.now()-86400000).toISOString(),aiMessage:'47Ğº Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾! Ğ”ĞµÑ€Ğ¶Ğ¸ Ñ‚ĞµĞ¼Ğ¿ ğŸš€'},
    ]},
    {id:2,name:'ĞĞ¾Ğ²Ñ‹Ğ¹ MacBook',target:200000,emoji:'ğŸ’»',color:'#22d47e',saved:32000,deposits:[
      {amount:32000,date:new Date(Date.now()-86400000*7).toISOString(),aiMessage:'32Ğº â€” 16% Ğº MacBook. Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ ğŸ’ª'},
    ]},
  ];
  saveG();
}
</script>
</body>
</html>
